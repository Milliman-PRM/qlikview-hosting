using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;

namespace MillimanCommon
{
    /// <summary>
    /// This class holds the repository of info generated by the PMC when attempting a mass
    /// reduction for all users
    /// </summary>
    public class QVWReportBank
    {
        public bool IsInError { get; set; }
        public string ErrorMessage { get; set; }

        private ProjectSettings PS { get; set; }
        private string ReportRoot { get; set; }

        private string NewItemsFile { get; set; }
        private string NoReductionFile { get; set; }
        private string NotSelectableFile { get; set; }
        private string ProcessingStatusFile { get; set; }
        private string AuditFile { get; set; }

        private string AutoInclusionFile { get; set; }

        private string DownloadsAuditFile { get; set; }

        public QVWReportBank(string QualifiedProject)
        {
            IsInError = false;
            if (QualifiedProject.Contains(':') == false)
            {
                string QVDocumentRoot = System.Configuration.ConfigurationManager.AppSettings["QVDocumentRoot"];
                QualifiedProject = System.IO.Path.Combine(QVDocumentRoot, QualifiedProject);
            }
            PS = ProjectSettings.Load(QualifiedProject);
            if (PS == null)
            {
                IsInError = true;
                ErrorMessage = "Could not load project '" + QualifiedProject + "'";
            }

            ReportRoot = System.IO.Path.Combine(System.IO.Path.GetDirectoryName(QualifiedProject), "ReducedUserQVWS\\ReductionReports");
            if (System.IO.Directory.Exists(ReportRoot) == false)
                System.IO.Directory.CreateDirectory(ReportRoot);

            if (System.IO.Directory.Exists(ReportRoot) == false)
            {
                IsInError = true;
                ErrorMessage = "Could not create directory for reports '" + QualifiedProject + "'";

            }

            NewItemsFile = System.IO.Path.Combine(ReportRoot, PS.QVName + ".newitems");
            NoReductionFile = System.IO.Path.Combine(ReportRoot, PS.QVName +".noreduction");
            NotSelectableFile = System.IO.Path.Combine(ReportRoot, PS.QVName +".notselectable");
            ProcessingStatusFile = System.IO.Path.Combine(ReportRoot, PS.QVName + ".processingstatus");
            AuditFile = System.IO.Path.Combine(ReportRoot, PS.QVName + ".audit");
            DownloadsAuditFile = System.IO.Path.Combine(ReportRoot, PS.QVName + ".downloads");
            AutoInclusionFile = System.IO.Path.Combine(ReportRoot, PS.QVName + ".autoinclude");

            if (LoadNewItems() == false)
            {
                IsInError = true;
                ErrorMessage = "Failed to load '" + NewItemsFile + "'";
            }
            
            //if (LoadFailedReductionItems() == false)
            //{
            //    IsInError = true;
            //    ErrorMessage = "Failed to load '" + NoReductionFile + "'";
            //}

            if (LoadNotSelectableItems() == false)
            {
                IsInError = true;
                ErrorMessage = "Failed to load '" + NotSelectableFile + "'";
            }

            if (LoadProcessingStatusList() == false)
            {
                IsInError = true;
                ErrorMessage = "Failed to load '" + ProcessingStatusFile + "'";
            }

            if (LoadAuditList() == false)
            {
                IsInError = true;
                ErrorMessage = "Failed to load '" + AuditFile + "'";
            }

            if (LoadDownloadAuditList() == false)
            {
                IsInError = true;
                ErrorMessage = "Failed to load '" + DownloadsAuditFile + "'";
            }
        }

        /// <summary>
        /// Clear all except downloads, which is never cleared
        /// </summary>
        public void ClearAll(  )
        {
            //VWN may want to archive this info instead of delete
            System.IO.File.Delete(NewItemsFile);
            System.IO.File.Delete(NoReductionFile);
            System.IO.File.Delete(NotSelectableFile);
            System.IO.File.Delete(ProcessingStatusFile);
            System.IO.File.Delete(AuditFile);

            NewItemList.Clear();
            //FailedReductionList.Clear();
            NotSelectableList.Clear();
            ProcessingStatusList.Clear();
            AuditList.Clear();
        }

        public class ClassBase
        {
            public DateTime Stamped { get; set; }
            public ClassBase()
            {
                Stamped = DateTime.Now;
            }
        }
        /// <summary>
        /// New items that are in "NEW" QVW that do not exist in
        /// the old QVW - serves as a basis for a client admin report
        /// </summary>
        public class NewItemClass : ClassBase
        {
            public string ItemConceptName { get; set; }
            public string ItemValue { get; set; }

            public NewItemClass() { }
            public NewItemClass(string _ItemConceptName, string _ItemValue)
            {
                ItemConceptName = _ItemConceptName;
                ItemValue = _ItemValue;
            }
        }

        /// <summary>
        /// List of users that could not have thier reduced view QVW recreated
        /// </summary>
        //public class FailedReductionClass : ClassBase
        //{
        //    public string UserName { get; set; }
        //    public string QVWName { get; set; }
        //    public string Reason { get; set; }

        //    public FailedReductionClass() { }
        //    public FailedReductionClass(string _UserName, string _QVWName, string _Reason)
        //    {
        //        UserName = _UserName;
        //        QVWName = _QVWName;
        //        Reason = _Reason;
        //    }
        //}

        /// <summary>
        /// Items selected for reduction by client admin that are no longer available
        /// </summary>
        public class NotSelectableClass : ClassBase
        {
            public string UserName { get; set; }
            public string FieldName { get; set; }
            public string ConceptFieldName { get; set; }
            public string QVWName { get; set; }
            public string Reason { get; set; }

            public NotSelectableClass() { }
            public NotSelectableClass(string _UserName, string _FieldName, string _ConceptFieldName, string _QVWName, string _Reason)
            {
                UserName = _UserName;
                FieldName = _FieldName;
                ConceptFieldName = _ConceptFieldName;
                QVWName = _QVWName;
                Reason = _Reason;
            }
        }

        /// <summary>
        /// Items automatically included by autoinclusion == true
        /// </summary>
        public class AutoInclusionClass : ClassBase
        {
            public string UserName { get; set; }
            public string FieldName { get; set; }
            public string ConceptFieldName { get; set; }
            public string QVWName { get; set; }
            public string Value { get; set; }

            public AutoInclusionClass() { }
            public AutoInclusionClass(string _UserName, string _FieldName, string _ConceptFieldName, string _QVWName, string _Value)
            {
                UserName = _UserName;
                FieldName = _FieldName;
                ConceptFieldName = _ConceptFieldName;
                QVWName = _QVWName;
                Value = _Value;
            }
        }
        /// <summary>
        /// Any failure when processing to produce the reduced QVW
        /// </summary>
        public class ProcessingStatusClass : ClassBase
        {
            public string UserName { get; set; }
            public string QVWName { get; set; }
            public string Reason { get; set; }

            public ProcessingStatusClass() { }
            public ProcessingStatusClass(string _Username, string _QVWName, string _Reason)
            {
                UserName = _Username;
                QVWName = _QVWName;
                Reason = _Reason;
            }
        }

        public class AuditClass : ClassBase
        {
            public string PMCUser { get; set; }
            public string LogMessage { get; set; }
            public AuditClass() { }
            public AuditClass(string _LogMessage)
            {
                LogMessage = _LogMessage;
                try
                {
                    PMCUser = System.Web.Security.Membership.GetUser().UserName;
                }
                catch (Exception ex)
                {
                    MillimanCommon.Report.Log(Report.ReportType.Error, "Could not get logged in user name", ex);
                    PMCUser = "?";
                }
            }
        }

        public enum DownloadClassType { ADDED, DELETED, MODIFIED, UNKNOWN };
        public class DownloadClass : ClassBase
        {
            public string DownloadFilename { get; set; }
            public DownloadClassType DownloadType { get; set; }
            public string ModifiedBy { get; set; }
            public DownloadClass() { }
            public DownloadClass(string _DownloadFilename,
                                 DownloadClassType _DownloadType)
            {
                DownloadFilename = _DownloadFilename;
                DownloadType = _DownloadType;

                //try and get logged in user name
                try
                {
                    ModifiedBy = System.Web.Security.Membership.GetUser().UserName;
                }
                catch (Exception)
                {
                }
            }
        }

        public bool AddItemToList(ClassBase Item)
        {
            if (Item is NewItemClass)
            {
                NewItemList.Add(Item as NewItemClass);
                return SaveNewItems();
            }
            //else if (Item is FailedReductionClass)
            //{
            //    FailedReductionList.Add(Item as FailedReductionClass);
            //    return SaveFailedReductionItems();
            //}
            else if (Item is NotSelectableClass)
            {
                NotSelectableList.Add(Item as NotSelectableClass);
                return SaveNotSelectableItems();
            }
            else if (Item is ProcessingStatusClass)
            {
                ProcessingStatusList.Add(Item as ProcessingStatusClass);
                return SaveProcessingStatusList();
            }
            else if (Item is DownloadClass)
            {
                DownloadAuditList.Add(Item as DownloadClass);
                return SaveDownloadAuditList();
            }
            else if (Item is AutoInclusionClass)
            {
                AutoInclusionList.Add(Item as AutoInclusionClass);
                return SaveAutoInclusionList();
            }
            else
            {
                AuditList.Add(Item as AuditClass);
                return SaveAuditList();
            }
        }

        public List<NewItemClass> NewItemList { get; set; }
        //public List<FailedReductionClass> FailedReductionList { get; set; }
        public List<NotSelectableClass> NotSelectableList { get; set; }
        public List<ProcessingStatusClass> ProcessingStatusList { get; set; }
        public List<AuditClass> AuditList { get; set; }
        public List<DownloadClass> DownloadAuditList { get; set; }
        public List<AutoInclusionClass> AutoInclusionList { get; set; }

        private bool SaveNewItems()
        {
            Polenter.Serialization.SharpSerializer SS = new Polenter.Serialization.SharpSerializer(false);
            if (System.IO.File.Exists(NewItemsFile))
                System.IO.File.Delete(NewItemsFile);
            System.IO.Directory.CreateDirectory(System.IO.Path.GetDirectoryName(NewItemsFile));
            SS.Serialize(NewItemList, NewItemsFile);
            return true;
        }
        //private bool SaveFailedReductionItems()
        //{
        //    Polenter.Serialization.SharpSerializer SS = new Polenter.Serialization.SharpSerializer(false);
        //    if (System.IO.File.Exists(NoReductionFile))
        //        System.IO.File.Delete(NoReductionFile);
        //    System.IO.Directory.CreateDirectory(System.IO.Path.GetDirectoryName(NoReductionFile));
        //    SS.Serialize(FailedReductionList, NoReductionFile);
        //    return true;
        //}
        private bool SaveNotSelectableItems()
        {
            Polenter.Serialization.SharpSerializer SS = new Polenter.Serialization.SharpSerializer(false);
            if ( System.IO.File.Exists(NotSelectableFile))
                System.IO.File.Delete(NotSelectableFile);
            System.IO.Directory.CreateDirectory(System.IO.Path.GetDirectoryName(NotSelectableFile));
            SS.Serialize(NotSelectableList, NotSelectableFile);
            return true;
        }
        private bool SaveProcessingStatusList()
        {
            Polenter.Serialization.SharpSerializer SS = new Polenter.Serialization.SharpSerializer(false);
            if ( System.IO.File.Exists(ProcessingStatusFile))
                System.IO.File.Delete(ProcessingStatusFile);
            System.IO.Directory.CreateDirectory(System.IO.Path.GetDirectoryName(ProcessingStatusFile));
            SS.Serialize(ProcessingStatusList, ProcessingStatusFile);
            return true;
        }
        private bool SaveAuditList()
        {
            Polenter.Serialization.SharpSerializer SS = new Polenter.Serialization.SharpSerializer(false);
            if ( System.IO.File.Exists(AuditFile))
                System.IO.File.Delete(AuditFile);
            System.IO.Directory.CreateDirectory(System.IO.Path.GetDirectoryName(AuditFile));
            SS.Serialize(AuditList, AuditFile);
            return true;

        }
        public bool SaveDownloadAuditList()
        {
            Polenter.Serialization.SharpSerializer SS = new Polenter.Serialization.SharpSerializer(false);
            if (System.IO.File.Exists( DownloadsAuditFile))
                System.IO.File.Delete(DownloadsAuditFile);
            System.IO.Directory.CreateDirectory(System.IO.Path.GetDirectoryName(DownloadsAuditFile));
            SS.Serialize(DownloadAuditList, DownloadsAuditFile);
            return true;
        }
        public bool SaveAutoInclusionList()
        {
            Polenter.Serialization.SharpSerializer SS = new Polenter.Serialization.SharpSerializer(false);
            if (System.IO.File.Exists(AutoInclusionFile))
                System.IO.File.Delete(AutoInclusionFile);
            System.IO.Directory.CreateDirectory(System.IO.Path.GetDirectoryName(AutoInclusionFile));
            SS.Serialize(AutoInclusionList, AutoInclusionFile);
            return true;
        }
        private bool LoadNewItems()
        {
            //file missing is ok, not an error
            if (System.IO.File.Exists(NewItemsFile) == false)
            {
                NewItemList = new List<NewItemClass>();
                return true;
            }
            Polenter.Serialization.SharpSerializer SS = new Polenter.Serialization.SharpSerializer(false);
            NewItemList = SS.Deserialize(NewItemsFile) as List<NewItemClass>;
            return true;
        }
        //private bool LoadFailedReductionItems()
        //{
        //    if (System.IO.File.Exists(NoReductionFile) == false)
        //    {
        //        FailedReductionList = new List<FailedReductionClass>();
        //        return true;
        //    }
        //    Polenter.Serialization.SharpSerializer SS = new Polenter.Serialization.SharpSerializer(false);
        //    FailedReductionList = SS.Deserialize(NoReductionFile) as List<FailedReductionClass>;
        //    return true;
        //}
        private bool LoadNotSelectableItems()
        {
            if (System.IO.File.Exists(NotSelectableFile) == false)
            {
                NotSelectableList = new List<NotSelectableClass>();
                return true;
            }
            Polenter.Serialization.SharpSerializer SS = new Polenter.Serialization.SharpSerializer(false);
            NotSelectableList = SS.Deserialize(NotSelectableFile) as List<NotSelectableClass>;
            return true;
        }
        private bool LoadProcessingStatusList()
        {
            if (System.IO.File.Exists(ProcessingStatusFile) == false)
            {
                ProcessingStatusList = new List<ProcessingStatusClass>();
                return true;
            }
            Polenter.Serialization.SharpSerializer SS = new Polenter.Serialization.SharpSerializer(false);
            ProcessingStatusList = SS.Deserialize(ProcessingStatusFile) as List<ProcessingStatusClass>;
            return true;
        }
        private bool LoadAuditList()
        {
            if (System.IO.File.Exists(AuditFile) == false)
            {
                AuditList = new List<AuditClass>();
                return true;
            }
            Polenter.Serialization.SharpSerializer SS = new Polenter.Serialization.SharpSerializer(false);
            AuditList = SS.Deserialize(AuditFile) as List<AuditClass>;
            return true;
        }

        private bool LoadDownloadAuditList()
        {
            if (System.IO.File.Exists(DownloadsAuditFile) == false)
            {
                DownloadAuditList = new List<DownloadClass>();
                return true;
            }
            Polenter.Serialization.SharpSerializer SS = new Polenter.Serialization.SharpSerializer(false);
            DownloadAuditList = SS.Deserialize(DownloadsAuditFile) as List<DownloadClass>;
            return true;
        }
        private bool LoadAutoInclusionList()
        {
            if (System.IO.File.Exists(AutoInclusionFile) == false)
            {
                AutoInclusionList = new List<AutoInclusionClass>();
                return true;
            }
            Polenter.Serialization.SharpSerializer SS = new Polenter.Serialization.SharpSerializer(false);
            AutoInclusionList = SS.Deserialize(AutoInclusionFile) as List<AutoInclusionClass>;
            return true;
        }
    }
}
